# Getting started (Scala.js + Golem Cloud)

This is the smallest end-to-end workflow for creating a new Golem app that runs Scala.js agent code, with `golem-cli` as the driver.

## Prerequisites

- `golem-cli` on your `PATH`
- Node.js + npm (used by the standard TypeScript/QuickJS packaging steps)
- Java + `sbt`
- A target to deploy to:
  - **Local**: run `golem-cli server run` in another terminal
  - **Cloud**: ensure you have a cloud profile configured (e.g. `golem-cli --cloud profile list`)

## 1) Create a new app + a new component (generated by golem-cli)

Create a new application scaffold that includes the standard TypeScript/QuickJS build pipeline:

```bash
golem-cli --yes app new my-scala-app ts
cd my-scala-app
```

List available templates (optional):

```bash
golem-cli component templates ts
```

Create a new component using a TypeScript agent template (we will keep this pipeline, but the agent logic will come from Scala.js):

```bash
golem-cli --yes component new ts demo:counter
```

## 2) Create the Scala.js project (sbt) that produces the JS bundle

Create an sbt project under `scala/`:

```bash
mkdir -p scala/project scala/src/main/scala/demo
```

Create `scala/project/plugins.sbt` with the following contents:

```scala
addSbtPlugin("org.scala-js" % "sbt-scalajs" % "1.20.1")
addSbtPlugin("dev.zio" % "zio-golem-sbt-plugin" % "<SDK_VERSION>")
```

Create `scala/build.sbt` with the following contents:

```scala
import org.scalajs.linker.interface.ModuleKind

ThisBuild / scalaVersion := "3.7.4"

lazy val root = project
  .in(file("."))
  .enablePlugins(org.scalajs.sbtplugin.ScalaJSPlugin, cloud.golem.sbt.GolemPlugin)
  .settings(
    name := "demo-counter-scala",
    scalaJSUseMainModuleInitializer := false,
    Compile / scalaJSLinkerConfig ~= (_.withModuleKind(ModuleKind.ESModule)),
    scalacOptions += "-experimental",
    libraryDependencies ++= Seq(
      "dev.zio" %%% "zio-golem-core"  % "<SDK_VERSION>",
      "dev.zio" %%% "zio-golem-model" % "<SDK_VERSION>",
      "dev.zio" %% "zio-golem-macros" % "<SDK_VERSION>"
    ),
    cloud.golem.sbt.GolemPlugin.autoImport.golemAppName := "demo-counter",
    cloud.golem.sbt.GolemPlugin.autoImport.golemComponent := "demo:counter",
    cloud.golem.sbt.GolemPlugin.autoImport.golemBundleFileName := "scala.js"
  )
```

## 3) Write a minimal durable counter agent in Scala

Create `scala/src/main/scala/demo/CounterAgent.scala` with the following contents:

```scala
package demo

import cloud.golem.runtime.annotations.{DurabilityMode, agentDefinition, agentImplementation}
import cloud.golem.sdk.BaseAgent

import scala.concurrent.Future
import scala.scalajs.concurrent.JSExecutionContext.Implicits.queue

@agentDefinition("counter-agent", mode = DurabilityMode.Durable)
trait CounterAgent extends BaseAgent {
  type AgentInput = String
  def increment(): Future[Double]
}

@agentImplementation()
final class CounterAgentImpl(name: String) extends CounterAgent {
  private var value: Double = 0

  override def increment(): Future[Double] =
    Future.successful {
      value += 1
      value
    }
}
```

## 4) Add a `scala.js` component template to the app

Create `common-scala-js/golem.yaml` with the following contents:

```yaml
templates:
  scala.js:
    build:
    - command: bash ../../build-scalajs.sh {{ component_name }}
    - command: npx tsc --noEmit false --emitDeclarationOnly --declaration --outFile ../../golem-temp/ts-check/{{ component_name | to_kebab_case }}/main.d.ts
      sources:
      - src
      - ../../common-ts
      - tsconfig.js
      targets:
      - ../../golem-temp/ts-check/{{ component_name | to_kebab_case }}/main.d.ts
    - command: npx --no golem-typegen ../../../components-ts/{{ component_name | to_kebab_case }}/tsconfig.json --files ../../../components-ts/{{ component_name | to_kebab_case }}/src/**/*.ts
      dir: ../../golem-temp/ts-metadata/{{ component_name | to_kebab_case }}
      sources:
      - ../../../components-ts/{{ component_name | to_kebab_case }}/src
      targets:
      - .metadata
    - command: npx --no rollup -- -c
      sources:
      - src
      - ../../common-ts
      - rollup.config.mjs
      - tsconfig.js
      - ../../golem-temp/ts-metadata/{{ component_name | to_kebab_case }}
      targets:
      - ../../golem-temp/ts-dist/{{ component_name | to_kebab_case }}/main.js
    - injectToPrebuiltQuickjs: ../../node_modules/@golemcloud/golem-ts-sdk/wasm/agent_guest.wasm
      module: ../../golem-temp/ts-dist/{{ component_name | to_kebab_case }}/main.js
      moduleWasm: ../../golem-temp/agents/{{ component_name | to_snake_case }}.module.wasm
      into: ../../golem-temp/agents/{{ component_name | to_snake_case }}.dynamic.wasm
    - generateAgentWrapper: ../../golem-temp/agents/{{ component_name | to_snake_case }}.wrapper.wasm
      basedOnCompiledWasm: ../../golem-temp/agents/{{ component_name | to_snake_case }}.dynamic.wasm
    - composeAgentWrapper: ../../golem-temp/agents/{{ component_name | to_snake_case }}.wrapper.wasm
      withAgent: ../../golem-temp/agents/{{ component_name | to_snake_case }}.dynamic.wasm
      to: ../../golem-temp/agents/{{ component_name | to_snake_case }}.static.wasm
    sourceWit: ../../node_modules/@golemcloud/golem-ts-sdk/wasm/agent_guest.wasm
    generatedWit: ../../golem-temp/agents/{{ component_name | to_snake_case }}/wit-generated
    componentWasm: ../../golem-temp/agents/{{ component_name | to_snake_case }}.static.wasm
    linkedWasm: ../../golem-temp/agents/{{ component_name | to_snake_case }}.wasm
```

## 5) Add the Scala build hook used by the template

Create `build-scalajs.sh` at the app root with the following contents (and mark it executable):

```bash
#!/usr/bin/env bash
set -euo pipefail

component="${1:?expected <component_name> (e.g. demo:counter)}"
app_dir="$(cd "$(dirname "$0")" && pwd)"

component_dir_name="${component//:/-}"
component_dir="$app_dir/components-ts/$component_dir_name"
scala_dir="$app_dir/scala"

( cd "$scala_dir" && sbt -batch -no-colors -Dsbt.supershell=false \
    compile \
    golemEnsureBridgeSpecManifest \
    golemGenerateScalaShim \
    fastLinkJS )

bundle="$(
  find "$scala_dir/target" -type f -path '*fastopt*/main.js' -printf '%T@ %p\n' 2>/dev/null \
    | sort -nr \
    | head -n 1 \
    | cut -d' ' -f2- \
    || true
)"

if [[ -z "$bundle" ]]; then
  echo "[scala.js] Could not locate Scala.js bundle under $scala_dir/target (expected */fastopt*/main.js)" >&2
  exit 1
fi

mkdir -p "$component_dir/src"
cp "$bundle" "$component_dir/src/scala.js"
echo "[scala.js] Wrote Scala.js bundle to $component_dir/src/scala.js" >&2
```

## 6) Switch the component to use the `scala.js` template

Edit `components-ts/demo-counter/golem.yaml` and change:

- `template: ts` â†’ `template: scala.js`

## 7) Replace the TypeScript agent implementation with a thin Scala.js wrapper

Replace `components-ts/demo-counter/src/main.ts` with the following contents:

```ts
// @ts-ignore Scala.js bundle does not ship TypeScript declarations
import * as scalaExports from "./scala.js";

import { BaseAgent, agent } from "@golemcloud/golem-ts-sdk";

const scalaAgents: any =
  (scalaExports as any).__golemInternalScalaAgents ?? (globalThis as any).__golemInternalScalaAgents;

@agent({ name: "counter-agent" })
class CounterAgent extends BaseAgent {
  private readonly impl: any;

  constructor(name: string) {
    super();
    this.impl = scalaAgents.newCounterAgent(name);
  }

  async increment(): Promise<number> {
    return await this.impl.increment();
  }
}
```

## 8) Deploy + invoke

From the app directory:

```bash
golem-cli --yes app deploy demo:counter
```

Invoke `increment` on the durable counter for id `"demo"`:

```bash
golem-cli --yes agent invoke 'demo:counter/counter-agent("demo")' 'counter-agent.{increment}'
```

To target Golem Cloud, add cloud flags (example):

```bash
golem-cli --cloud -p <profile> --yes app deploy demo:counter
golem-cli --cloud -p <profile> --yes agent invoke 'demo:counter/counter-agent("demo")' 'counter-agent.{increment}'
```

